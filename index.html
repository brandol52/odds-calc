<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Odds Calc</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0c111b">

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Odds Calc">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root{--bg:#0c111b;--fg:#edf2f7;--muted:#9aa4b2;--card:#0f172a;--border:#1f2537;--accent:#22c55e}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:560px;margin:0 auto;padding:16px;padding-bottom:calc(16px + env(safe-area-inset-bottom))}
    h1{font-size:18px;margin:10px 0 8px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}

    /* two inputs on one line */
    .inputs-line{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px}
    label{display:block;font-size:.85rem;color:var(--muted);margin-bottom:6px}

    /* Odds line: toggle on the LEFT, then input */
    .odds-line{display:grid;grid-template-columns:56px 1fr;gap:8px}
    .btn{padding:12px;border-radius:12px;border:1px solid var(--border);background:#0d1930;color:var(--fg);font-size:1.05rem;cursor:pointer}
    .btn:active{transform:translateY(1px)}

    input[type="text"]{
      width:100%;padding:12px 14px;border-radius:12px;background:#0a1020;color:var(--fg);
      border:1px solid var(--border);outline:none;font-size:1.05rem
    }
    input:focus{border-color:#2dd4bf;box-shadow:0 0 0 .12rem rgba(45,212,191,.16)}

    /* stake underneath, BIG & green */
    .stake{margin-top:10px;background:#0a1020;border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center}
    .stake small{display:block;color:var(--muted);font-size:.85rem;margin-bottom:6px}
    .stake .val{font-weight:900;letter-spacing:.2px;font-size:2rem;color:var(--accent)}

    .sub{color:var(--muted);font-size:.85rem;margin:10px 2px 0}
    .foot{color:var(--muted);font-size:.78rem;text-align:center;margin:14px 0 8px}
    @supports (padding: max(0px)) {.wrap{padding-top:max(16px,env(safe-area-inset-top));padding-bottom:max(16px,env(safe-area-inset-bottom));}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>American Odds — App Mode</h1>
    <div class="card">
      <!-- Inputs on the same line -->
      <div class="inputs-line">
        <div>
          <label for="odds">American Odds</label>
          <div class="odds-line">
            <button type="button" class="btn" id="toggleBtn" aria-label="Switch odds sign" title="Switch odds sign">−</button>
            <input id="odds" type="text" inputmode="numeric" placeholder="-110 or +145" aria-label="American odds">
          </div>
        </div>
        <div>
          <label for="win">Amount to Win</label>
          <input id="win" type="text" inputmode="numeric" placeholder="$25.00" aria-label="Amount to win in dollars">
        </div>
      </div>

      <!-- Stake underneath -->
      <div class="stake">
        <small>Required Amount to Bet</small>
        <div class="val" id="stake">$0.00</div>
      </div>

      <div class="sub">Add to Home Screen from Safari to launch full‑screen and work offline.</div>
    </div>
    <div class="foot">
      © Bryan Randol • stake = win × (|odds|/100) for negative, win × (100/odds) for positive<br>
      <small style="color:#9aa4b2">Build v08-18-2025-3</small>
    </div>
  </div>

  <script>
    // --- PWA registration (safe) ---
    (function(){
      if (!('serviceWorker' in navigator)) return;
      window.addEventListener('load', function(){
        navigator.serviceWorker.register('./service-worker.js')
          .then(function(reg){
            try {
              reg.update();
              setInterval(function(){ reg.update(); }, 15*60*1000);
              reg.addEventListener('updatefound', function(){
                var nw = reg.installing; if (!nw) return;
                nw.addEventListener('statechange', function(){
                  if (nw.state === 'installed' && navigator.serviceWorker.controller) {
                    (reg.waiting || nw).postMessage('SKIP_WAITING');
                  }
                });
              });
              navigator.serviceWorker.addEventListener('controllerchange', function(){ location.reload(); });
            } catch(e){}
          })
          .catch(function(){});
      });
    })();

    // ---- Calculator logic ----
    (function(){
      function $(id){ return document.getElementById(id); }
      function money(v){ return (isFinite(v) ? (Math.round(v*100)/100).toLocaleString(undefined,{style:'currency',currency:'USD'}) : "$0.00"); }

      function parseOdds(raw){
        if(!raw) return null;
        raw = String(raw).trim();
        if(/^[+-]?\d+$/.test(raw)) return parseFloat(raw);
        var cleaned = raw.replace(/[^\d\-+]/g,"");
        if(cleaned === "" || cleaned === "+" || cleaned === "-") return null;
        return parseFloat(cleaned);
      }

      // Format odds in the field with explicit sign (+ for positive, - for negative)
      function formatOddsField(odds){
        var el = $("odds"); if (!el) return;
        if (odds == null || !isFinite(odds)) return;
        var abs = Math.abs(Math.trunc(odds));
        el.value = (odds > 0 ? "+" + abs : "-" + abs);
      }

      // Currency mask (moving decimal) for win
      function getWinCents(){
        var el = $("win"); if (!el) return 0;
        var raw = el.dataset.cents; return raw ? parseInt(raw,10) : 0;
      }
      function setWinCents(cents){
        var el = $("win"); if (!el) return;
        cents = Math.max(0, isFinite(cents) ? Math.trunc(cents) : 0);
        el.dataset.cents = String(cents);
        el.value = (cents/100).toLocaleString(undefined,{style:'currency',currency:'USD'});
      }
      function handleWinInput(e){
        var digits = (e.target.value.match(/\d/g) || []).join("");
        var cents = digits === "" ? 0 : parseInt(digits,10);
        setWinCents(cents); calculate();
      }
      function handleWinKeyDown(e){
        var allowed = ["Backspace","Delete","ArrowLeft","ArrowRight","Tab","Home","End"];
        if (allowed.indexOf(e.key) !== -1) return;
        if (/^\d$/.test(e.key)) return;
        e.preventDefault();
      }
      function pasteDigitsOnly(e){
        e.preventDefault();
        var text = (e.clipboardData || window.clipboardData || {getData:function(){return "";}}).getData("text");
        var digits = (text.match(/\d/g) || []).join("");
        var cents = digits === "" ? getWinCents() : parseInt(digits,10);
        setWinCents(cents); calculate();
      }

      function calcStake(odds, win){
        if(odds == null || !isFinite(odds) || !isFinite(win) || odds === 0) return NaN;
        return odds > 0 ? (win*100/odds) : (win*Math.abs(odds)/100);
      }

      function updateToggleLabel(odds){
        var btn = $("toggleBtn"); if (!btn) return;
        var showMinus = (odds != null && isFinite(odds) && odds > 0);
        btn.textContent = showMinus ? "−" : "+";
        btn.title = showMinus ? "Switch to negative odds" : "Switch to positive odds";
        btn.setAttribute("aria-label", btn.title);
      }

      function calculate(){
        var oddsRaw = ($("odds")||{}).value||"";
        var odds = parseOdds(oddsRaw);
        var win  = getWinCents() / 100;
        var stake = calcStake(odds, win);
        var stakeEl = $("stake"); if (stakeEl) stakeEl.textContent = money(stake);

        // Ensure the odds field shows explicit + for positive
        if (odds != null && isFinite(odds)) formatOddsField(odds);

        updateToggleLabel(odds);
      }

      function bind(){
        var oddsEl = $("odds"), winEl = $("win"), btn = $("toggleBtn");
        if (!oddsEl || !winEl || !btn) return false;

        btn.addEventListener("click", function(){
          var n = parseOdds(oddsEl.value);
          n = (n == null || !isFinite(n)) ? -110 : (n * -1);
          oddsEl.value = String(n);
          // calculate() will re-render with proper +/−
          calculate();
        });

        oddsEl.addEventListener("input", calculate);
        oddsEl.addEventListener("blur", function(){
          var n = parseOdds(oddsEl.value);
          if (n != null && isFinite(n)) formatOddsField(n);
        });

        winEl.addEventListener("input", handleWinInput);
        winEl.addEventListener("keydown", handleWinKeyDown);
        winEl.addEventListener("paste", pasteDigitsOnly);
        return true;
      }

      function init(){
        if (!bind()) { setTimeout(init, 50); return; }  // Retry binding if DOM not ready
        $("odds").value = "-110";
        setWinCents(2500);
        calculate();
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Odds Calc</title>
  <meta name="theme-color" content="#0c111b">
  <style>
    :root{
      --bg:#0c111b;--fg:#edf2f7;--muted:#9aa4b2;
      --card:#0f172a;--border:#1f2537;--accent:#22c55e;--bad:#ef4444
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);color:var(--fg);min-height:100vh;display:flex;flex-direction:column;
      padding-top:calc(env(safe-area-inset-top) + 12px);padding-bottom:env(safe-area-inset-bottom);
      padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right)}
    .wrap{max-width:560px;width:100%;margin:0 auto;padding:16px;flex:1;display:flex;flex-direction:column;gap:16px}
    h1{font-size:18px;margin:0 0 4px}
    .muted{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:10px;align-items:center}
    .col{flex:1}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"]{width:100%;background:#0b1324;border:1px solid var(--border);border-radius:10px;
      color:var(--fg);padding:10px 12px;font-size:16px;outline:none}
    input[type="text"]:focus{border-color:#334155;box-shadow:0 0 0 2px #33415555}
    button.toggle{border:1px solid var(--border);background:#0b1324;color:var(--fg);border-radius:10px;padding:10px 12px;font-size:14px}
    .invalid{border-color:var(--bad)}
    .result{display:flex;justify-content:space-between;gap:10px;font-variant-numeric:tabular-nums}
    .result .val{font-weight:600}
    .result-line{display:flex;justify-content:space-between;padding:8px 10px;background:#0c1428;border-radius:10px;border:1px solid var(--border)}
    .small{font-size:12px}
    .spacer8{height:8px}
  </style>
  <link rel="manifest" href="./manifest.webmanifest">
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Odds Calc</h1>
      <div class="muted small">Stake/Win math and market juice.</div>
    </header>

    <!-- Calculator 1: Stake to Win -->
    <section class="card" aria-labelledby="calc1">
      <h2 id="calc1" class="muted" style="font-size:14px;margin:0">Stake → Win</h2>
      <div class="row">
        <div class="col">
          <label for="odds">American Odds</label>
          <input id="odds" type="text" inputmode="numeric" pattern="-?\d*" placeholder="+150 or -120" aria-describedby="oddsHelp">
          <div id="oddsHelp" class="small muted">Tap ± to flip sign if needed.</div>
        </div>
        <div>
          <label for="toggleBtn" class="muted small">&nbsp;</label>
          <button id="toggleBtn" class="toggle" type="button" title="Switch sign" aria-label="Switch sign">±</button>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label for="win">Target Win ($)</label>
          <input id="win" type="text" inputmode="decimal" placeholder="e.g. 10.00">
        </div>
      </div>
      <div class="spacer8"></div>
      <div class="result-line" aria-live="polite" aria-atomic="true">
        <div>Stake Required</div>
        <div class="val" id="stakeOut">—</div>
      </div>
      <div class="result-line">
        <div>Break-even (Implied)</div>
        <div class="val" id="breakeven1">—</div>
      </div>
    </section>

    <!-- Calculator 2: Juice Calculator (replaces Win from Stake) -->
    <section class="card" aria-labelledby="juiceCalc">
      <h2 id="juiceCalc" class="muted" style="font-size:14px;margin:0">Juice / Overround</h2>
      <div class="row">
        <div class="col">
          <label for="sideA">Side A Odds</label>
          <input id="sideA" type="text" inputmode="numeric" pattern="-?\d*" placeholder="-110">
        </div>
        <div>
          <label for="flipA" class="muted small">&nbsp;</label>
          <button id="flipA" class="toggle" type="button" title="Switch sign A" aria-label="Switch sign A">±</button>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label for="sideB">Side B Odds</label>
          <input id="sideB" type="text" inputmode="numeric" pattern="-?\d*" placeholder="-110">
        </div>
        <div>
          <label for="flipB" class="muted small">&nbsp;</label>
          <button id="flipB" class="toggle" type="button" title="Switch sign B" aria-label="Switch sign B">±</button>
        </div>
      </div>
      <div class="spacer8"></div>
      <div class="result-line" aria-live="polite" aria-atomic="true">
        <div>Total Implied (A+B)</div>
        <div class="val" id="sumImpl">—</div>
      </div>
      <div class="result-line">
        <div>Juice / Overround</div>
        <div class="val" id="juicePct">—</div>
      </div>
      <div class="result-line">
        <div>No‑Vig Prob A / B</div>
        <div class="val" id="nvProbs">—</div>
      </div>
      <div class="result-line">
        <div>No‑Vig Odds A / B</div>
        <div class="val" id="nvOdds">—</div>
      </div>
      <div class="small muted">Tip: enter both sides of a 2‑way market (e.g., spread or total). Overround = (ImpA + ImpB − 1).</div>
    </section>

    <footer class="small muted" style="text-align:center;padding:8px 0 24px">
      v1.1 — Juice calculator added
    </footer>
  </div>

  <script>
    // ---------- Math helpers ----------
    const americanToProb = (o) => {
      if (!Number.isFinite(o) || o === 0) return NaN;
      return o > 0 ? 100/(o+100) : Math.abs(o)/(Math.abs(o)+100);
    };
    const probToAmerican = (p) => {
      if (!(p > 0 && p < 1)) return NaN;
      return p > 0.5 ? -Math.round(100*p/(1-p)) : Math.round(100*(1-p)/p);
    };
    const stakeForWin = (o, want) => {
      if (!Number.isFinite(o) || !Number.isFinite(want) || o === 0) return NaN;
      return o > 0 ? (want*100)/o : (want*Math.abs(o))/100;
    };

    // ---------- DOM utils ----------
    const $ = (id) => document.getElementById(id);
    const parseOdds = (el) => {
      const t = (el.value || "").replace(/[^0-9+-]/g,"");
      if (t === "" || t === "+" || t === "-" || t === "+-" || t === "-+") return NaN;
      const n = Number(t);
      if (!Number.isFinite(n) || n === 0) return NaN;
      return n;
    };
    const parseMoney = (el) => {
      const t = (el.value || "").replace(/[^0-9.]/g,"");
      if (t === "" || /^\.$/.test(t)) return NaN;
      const n = Number(t);
      return Number.isFinite(n) && n >= 0 ? n : NaN;
    };
    const fmtUSD = (n) => isNaN(n) ? "—" : "$" + n.toFixed(2);
    const fmtPct = (p) => isNaN(p) ? "—" : (p*100).toFixed(2) + "%";
    const fmtOdds = (o) => isNaN(o) ? "—" : (o>0?"+":"") + String(o);

    const setValidity = (el, ok) => {
      if (!el) return;
      if (ok) el.classList.remove("invalid"); else el.classList.add("invalid");
    };

    // ---------- Calc 1: Stake -> Win ----------
    function calculate1() {
      const o = parseOdds($("odds"));
      const w = parseMoney($("win"));
      setValidity($("odds"), Number.isFinite(o));
      setValidity($("win"), Number.isFinite(w));
      if (!Number.isFinite(o) || !Number.isFinite(w)) {
        $("stakeOut").textContent = "—";
        $("breakeven1").textContent = "—";
        return;
      }
      const stake = stakeForWin(o, w);
      const p = americanToProb(o);
      $("stakeOut").textContent = fmtUSD(stake);
      $("breakeven1").textContent = fmtPct(p);
    }

    // ---------- Calc 2: Juice / Overround ----------
    function calculateJuice() {
      const a = parseOdds($("sideA"));
      const b = parseOdds($("sideB"));
      setValidity($("sideA"), Number.isFinite(a));
      setValidity($("sideB"), Number.isFinite(b));
      if (!Number.isFinite(a) || !Number.isFinite(b)) {
        $("sumImpl").textContent = "—";
        $("juicePct").textContent = "—";
        $("nvProbs").textContent = "—";
        $("nvOdds").textContent = "—";
        return;
      }
      const pA = americanToProb(a);
      const pB = americanToProb(b);
      const sum = pA + pB;
      const juice = sum - 1; // overround
      $("sumImpl").textContent = fmtPct(sum);
      $("juicePct").textContent = fmtPct(juice);

      // No-vig normalization
      if (sum > 0) {
        const nvA = pA / sum;
        const nvB = pB / sum;
        $("nvProbs").textContent = fmtPct(nvA) + " / " + fmtPct(nvB);
        const nvAOdds = probToAmerican(nvA);
        const nvBOdds = probToAmerican(nvB);
        $("nvOdds").textContent = fmtOdds(nvAOdds) + " / " + fmtOdds(nvBOdds);
      } else {
        $("nvProbs").textContent = "—";
        $("nvOdds").textContent = "—";
      }
    }

    // ---------- Wiring & toggles ----------
    function bind() {
      const debounce = (fn, ms=120) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms);} };
      $("odds").addEventListener("input", debounce(calculate1));
      $("win").addEventListener("input", debounce(calculate1));
      $("toggleBtn").addEventListener("click", () => { const el=$("odds"); const v=parseOdds(el); if (Number.isFinite(v)) el.value = (v>0? -v : Math.abs(v)); calculate1(); });

      const jcalc = debounce(calculateJuice);
      $("sideA").addEventListener("input", jcalc);
      $("sideB").addEventListener("input", jcalc);
      $("flipA").addEventListener("click", () => { const el=$("sideA"); const v=parseOdds(el); if (Number.isFinite(v)) el.value = (v>0? -v : Math.abs(v)); calculateJuice(); });
      $("flipB").addEventListener("click", () => { const el=$("sideB"); const v=parseOdds(el); if (Number.isFinite(v)) el.value = (v>0? -v : Math.abs(v)); calculateJuice(); });

      // Initial computes
      calculate1();
      calculateJuice();
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", bind);
    } else { bind(); }
  </script>

  <script>
    // PWA: register service worker if present
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    }
  </script>
</body>
</html>

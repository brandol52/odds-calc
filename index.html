<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Odds Calc</title>
  <meta name="theme-color" content="#0c111b">
  <style>
    :root{--bg:#0c111b;--fg:#edf2f7;--muted:#9aa4b2;--card:#0f172a;--border:#1f2537;--accent:#22c55e;--bad:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);color:var(--fg);min-height:100dvh;display:flex;flex-direction:column;
      padding-top:calc(env(safe-area-inset-top) + 8px);padding-bottom:env(safe-area-inset-bottom);
      padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right)}
    .wrap{max-width:560px;width:100%;margin:0 auto;padding:12px;flex:1;display:grid;grid-template-rows:auto auto auto 1fr auto;row-gap:10px;overflow:hidden}
    h1{font-size:18px;margin:0 0 4px}
    .muted{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:10px;align-items:center}
    .col{flex:1}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"]{width:100%;background:#0b1324;border:1px solid var(--border);border-radius:10px;
      color:var(--fg);padding:10px 12px;font-size:16px;outline:none}
    input[type="text"]:focus{border-color:#334155;box-shadow:0 0 0 2px #33415555}
    button.toggle{border:1px solid var(--border);background:#0b1324;color:var(--fg);border-radius:10px;padding:10px 12px;font-size:14px}
    .invalid{border-color:var(--bad)}
    .result-line{display:flex;justify-content:space-between;padding:8px 10px;background:#0c1428;border-radius:10px;border:1px solid var(--border);font-variant-numeric:tabular-nums}
    .small{font-size:12px}
    @media (max-width: 430px){
      h1{font-size:16px}
      .card{padding:12px;border-radius:12px}
      .result-line{padding:6px 8px}
      input[type="text"]{padding:9px 10px;font-size:15px}
      .small{font-size:11px}
      .muted{opacity:.95}
      .wrap{row-gap:8px}
    }
    html, body {overscroll-behavior: contain}
  </style>
  <link rel="manifest" href="./manifest.webmanifest">
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Odds Calc</h1>
      <div class="muted small">Stake/Win math and market juice.</div>
    </header>

    <!-- Stake → Win -->
    <section class="card" aria-labelledby="calc1">
      <h2 id="calc1" class="muted" style="font-size:14px;margin:0">Stake → Win</h2>
      <div class="row">
        <div class="col">
          <label for="odds">American Odds</label>
          <input id="odds" type="text" inputmode="numeric" placeholder="+150 or -120" aria-describedby="oddsHelp">
          <div id="oddsHelp" class="small muted">Use American odds with |odds| ≥ 100 (e.g., -110, +120).</div>
        </div>
        <div>
          <label for="toggleBtn" class="muted small">&nbsp;</label>
          <button id="toggleBtn" class="toggle" type="button">±</button>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label for="win">Target Win ($)</label>
          <input id="win" type="text" inputmode="numeric" placeholder="$0.00" value="$0.00">
        </div>
      </div>
      <div class="result-line" aria-live="polite">
        <div>Stake Required</div>
        <div class="val" id="stakeOut">—</div>
      </div>
      <div class="result-line">
        <div>Break-even (Implied)</div>
        <div class="val" id="breakeven1">—</div>
      </div>
    </section>

    <!-- Juice Calculator -->
    <section class="card" aria-labelledby="juiceCalc">
      <h2 id="juiceCalc" class="muted" style="font-size:14px;margin:0">Juice / Overround</h2>
      <div class="row">
        <div class="col">
          <label for="sideA">Side A Odds</label>
          <input id="sideA" type="text" inputmode="numeric" placeholder="-110">
          <div class="small muted">Auto-filled from Stake → Win odds.</div>
        </div>
        <div>
          <button id="flipA" class="toggle" type="button">±</button>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label for="sideB">Side B Odds</label>
          <input id="sideB" type="text" inputmode="numeric" placeholder="Enter the other side (e.g., -110)">
        </div>
        <div>
          <button id="flipB" class="toggle" type="button">±</button>
        </div>
      </div>
      <div class="result-line" aria-live="polite">
        <div>Total Implied (A+B)</div>
        <div class="val" id="sumImpl">—</div>
      </div>
      <div class="result-line">
        <div>Juice / Overround</div>
        <div class="val" id="juicePct">—</div>
      </div>
      <div class="result-line">
        <div>No-Vig Prob A / B</div>
        <div class="val" id="nvProbs">—</div>
      </div>
      <div class="result-line">
        <div>No-Vig Odds A / B</div>
        <div class="val" id="nvOdds">—</div>
      </div>
    </section>

    <footer class="small muted" style="text-align:center;padding:6px 0 12px">
      Built by <strong>Bryan Randol (Pikkit: @Shakademus)</strong> • Build-Seasmoke
    </footer>
  </div>

  <script>
  // ---------- Math ----------
  const americanToProb = (o) => (!Number.isFinite(o) || o===0) ? NaN : (o>0 ? 100/(o+100) : Math.abs(o)/(Math.abs(o)+100));
  const probToAmerican = (p) => (!(p>0 && p<1)) ? NaN : (p>0.5 ? -Math.round(100*p/(1-p)) : Math.round(100*(1-p)/p));
  const stakeForWin = (o, want) => (!Number.isFinite(o)||!Number.isFinite(want)||o===0) ? NaN : (o>0 ? (want*100)/o : (want*Math.abs(o))/100);

  // ---------- DOM + formatting ----------
  const $ = (id) => document.getElementById(id);
  const USD = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2,maximumFractionDigits:2});
  const fmtUSD = (n) => isNaN(n) ? "—" : USD.format(n);
  const fmtPct = (p) => isNaN(p) ? "—" : (p*100).toFixed(2) + "%";
  const fmtOdds = (o) => isNaN(o) ? "—" : (o>0?"+":"") + String(o);

  const markValidity = (el, ok, helpEl, helpOkText, helpErrText) => {
    el.classList.toggle("invalid", !ok);
    el.setAttribute("aria-invalid", ok ? "false" : "true");
    if (helpEl) helpEl.textContent = ok ? helpOkText : helpErrText;
  };

  // ---------- Odds ----------
  function sanitizeOddsWhileTyping(el){
    // Only keep optional leading sign and digits
    const m = (el.value||"").match(/^[\+\-]?\d*/);
    const keep = m ? m[0] : "";
    if (el.value !== keep) {
      const pos = keep.length;
      el.value = keep;
      try { el.setSelectionRange(pos, pos); } catch {}
    }
  }
  function readOdds(el){
    const t = (el.value||"").trim();
    if (!/^[+-]?\d+$/.test(t)) return NaN;     // must be full integer
    return Number(t);
  }
  const isValidOdds = (n) => Number.isFinite(n) && Math.abs(n) >= 100;

  // ---------- $ input mask (digits => cents => $X,XXX.XX) ----------
  function digitsToUSD(d){ const cents = d? parseInt(d,10) : 0; return USD.format((isNaN(cents)?0:cents)/100); }
  function attachMoneyMask(el, onChange){
    if (!el.dataset.digits) el.dataset.digits = "";
    el.value = digitsToUSD(el.dataset.digits);
    el.addEventListener("input", ()=>{
      const raw = (el.value||"").replace(/\D/g,"");
      el.dataset.digits = raw;
      el.value = digitsToUSD(raw);
      onChange && onChange();
    });
    el.addEventListener("paste", (e)=>{
      e.preventDefault();
      const pasted = (e.clipboardData?.getData("text")||"").replace(/\D/g,"");
      el.dataset.digits = (el.dataset.digits||"") + pasted;
      el.value = digitsToUSD(el.dataset.digits);
      onChange && onChange();
    });
  }
  const parseMoney = (el)=> {
    const d = el.dataset.digits || "";
    const cents = d==="" ? 0 : parseInt(d,10);
    return Number.isFinite(cents) ? cents/100 : NaN;
  };

  // ---------- Calculations ----------
  function calculateStake(){
    const oddsEl = $("odds");
    const help = $("oddsHelp");
    const o = readOdds(oddsEl);
    const w = parseMoney($("win"));
    const okOdds = isValidOdds(o);
    const okWin = Number.isFinite(w);
    markValidity(oddsEl, okOdds, help, "Tap ± to flip sign if needed.", "Use American odds with |odds| ≥ 100 (e.g., -110, +120).");
    markValidity($("win"), okWin);

    if (!okOdds || !okWin){
      $("stakeOut").textContent = "—";
      $("breakeven1").textContent = "—";
      return;
    }
    $("stakeOut").textContent = fmtUSD(stakeForWin(o, w));
    $("breakeven1").textContent = fmtPct(americanToProb(o));
  }

  function calculateJuice(){
    const a = readOdds($("sideA"));
    const b = readOdds($("sideB"));
    const aOk = isValidOdds(a), bOk = isValidOdds(b);
    markValidity($("sideA"), aOk);
    markValidity($("sideB"), bOk);
    if (!aOk || !bOk){
      $("sumImpl").textContent="—";
      $("juicePct").textContent="—";
      $("nvProbs").textContent="—";
      $("nvOdds").textContent="—";
      return;
    }
    const pA = americanToProb(a), pB = americanToProb(b);
    const sum = pA + pB, juice = sum - 1;
    $("sumImpl").textContent = fmtPct(sum);
    $("juicePct").textContent = fmtPct(juice);
    if (sum>0){
      const nvA=pA/sum, nvB=pB/sum;
      $("nvProbs").textContent = fmtPct(nvA)+" / "+fmtPct(nvB);
      $("nvOdds").textContent = fmtOdds(probToAmerican(nvA))+" / "+fmtOdds(probToAmerican(nvB));
    } else {
      $("nvProbs").textContent="—";
      $("nvOdds").textContent="—";
    }
  }

  // ---------- Wiring ----------
  function bind(){
    // Money mask
    attachMoneyMask($("win"), calculateStake);

    // Odds fields: sanitize while typing; validate on every input
    ["odds","sideA","sideB"].forEach(id=>{
      const el = $(id);
      el.addEventListener("input", ()=>{
        sanitizeOddsWhileTyping(el);
        if (id==="odds"){
          // hard-sync Stake odds to Juice Side A
          $("sideA").value = el.value;
        }
        calculateStake();
        calculateJuice();
      });
    });

    // ± buttons
    $("toggleBtn").addEventListener("click", ()=>{
      const el=$("odds");
      if (!el.value) return;
      el.value = el.value.startsWith("-") ? el.value.slice(1) : (el.value.startsWith("+")? "-"+el.value.slice(1) : "-"+el.value);
      el.dispatchEvent(new Event("input",{bubbles:true}));
    });
    $("flipA").addEventListener("click", ()=>{
      const el=$("sideA"); if (!el.value) return;
      el.value = el.value.startsWith("-") ? el.value.slice(1) : (el.value.startsWith("+")? "-"+el.value.slice(1) : "-"+el.value);
      el.dispatchEvent(new Event("input",{bubbles:true}));
    });
    $("flipB").addEventListener("click", ()=>{
      const el=$("sideB"); if (!el.value) return;
      el.value = el.value.startsWith("-") ? el.value.slice(1) : (el.value.startsWith("+")? "-"+el.value.slice(1) : "-"+el.value);
      el.dispatchEvent(new Event("input",{bubbles:true}));
    });

    // Initial render
    $("win").dataset.digits = "";
    $("win").value = USD.format(0);
    calculateStake();
    $("sideA").value = $("odds").value; // initial autofill
    calculateJuice();
  }
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", bind); else bind();
</script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Odds Calc — Stake Window (Build-Tessarion)</title>
  <meta name="theme-color" content="#5A1414">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/favicon.ico">
  <style>
    :root{
      --bg:#0b1118;--fg:#eef1f5;--muted:#9aa4b2;--card:#0f172a;--border:#1c2234;
      --ok:#22c55e;--btn:#0b1324;--btnActive:#18223a
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; width:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      overflow:hidden; /* keep single-screen layout */
    }
    .wrap{
      max-width:560px; width:100%; margin:0 auto;
      padding:calc(10px + env(safe-area-inset-top))
              calc(12px + env(safe-area-inset-right))
              10px
              calc(12px + env(safe-area-inset-left));
      display:grid; row-gap:8px; height:100%;
      grid-template-rows:auto auto 1fr auto;
    }
    h1{margin:0 0 2px;font-size:16px}
    .muted{color:var(--muted)} .small{font-size:11px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:8px;align-items:center}
    .col{flex:1}
    label{display:block;margin-bottom:4px;color:var(--muted);font-size:12px}
    .field{position:relative}
    input[type=text]{width:100%;background:#0a1324;border:1px solid var(--border);border-radius:8px;color:var(--fg);
      padding:8px 10px;font-size:15px;outline:none;-webkit-appearance:none}
    input[type=text]:focus{border-color:#31405e;box-shadow:0 0 0 2px #31405e55}
    .valid{border-color:var(--ok)}
    .invalid{border-color:#ef4444}
    button{border:1px solid var(--border);background:var(--btn);color:var(--fg);border-radius:8px;padding:8px 10px;font-size:14px}
    .result{display:flex;justify-content:space-between;gap:8px;padding:6px 8px;background:#0c1428;border:1px solid var(--border);border-radius:8px;font-variant-numeric:tabular-nums}

    /* Window grid */
    .chartCard{gap:6px;padding:8px}
    .chartHeader{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);padding:0 2px}
    .subhead{font-size:11px;color:var(--muted);padding:0 2px;margin-top:-4px}
    .grid{
      column-count:12; column-gap:3px; height:100%; max-width:100%;
    }
    @media (max-width:430px){ .grid{ column-count:12; } }
    @media (max-width:400px){ .grid{ column-count:11; } }
    @media (max-width:375px){ .grid{ column-count:10; } }

    .cell{
      break-inside:avoid;
      display:flex;justify-content:space-between;align-items:center;
      padding:4px 5px;margin:0 0 4px 0;border:1px solid var(--border);border-radius:6px;
      background:#0c1428;font-variant-numeric:tabular-nums;line-height:1.05;
      font-size:10.5px;min-height:18px;max-width:100%;overflow:hidden
    }
    .odds{color:var(--muted)}
    .amt{font-weight:700;color:var(--ok);white-space:nowrap;text-overflow:ellipsis}

    footer{font-size:10.5px;color:var(--muted);text-align:center;padding:2px 0 4px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Stake Window</h1>
      <div class="muted small">Build-Tessarion • Enter desired win + odds → stakes</div>
    </header>

    <!-- Inputs -->
    <section class="card">
      <div class="row">
        <div class="col">
          <label for="win">Desired Win ($)</label>
          <div class="field">
            <input id="win" type="text" inputmode="numeric" placeholder="$0.00" autocomplete="off" autocorrect="off" spellcheck="false">
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label for="odds">American Odds</label>
          <div class="field">
            <input id="odds" type="text" inputmode="numeric" placeholder="+150 or -120" autocomplete="off" autocorrect="off" spellcheck="false" maxlength="6">
          </div>
        </div>
        <div>
          <label class="small muted">&nbsp;</label>
          <button id="toggleOdds" type="button" title="Flip sign">±</button>
        </div>
      </div>
      <div class="result"><div>Required Stake</div><div id="stakeOut">—</div></div>
      <div class="result"><div>Break-even (Implied)</div><div id="breakeven">—</div></div>
    </section>

    <!-- Window (±100 points on same sign) -->
    <section class="card chartCard">
      <div class="chartHeader">
        <div>American Odds</div>
        <div>Stake Required</div>
      </div>
      <div id="rangeNote" class="subhead">—</div>
      <div id="grid" class="grid" aria-live="polite"></div>
    </section>

    <footer>
      Built by <strong>Bryan Randol</strong> • <strong>Build-Tessarion</strong>
    </footer>
  </div>

<script>
/* --- Helpers --- */
const USD=new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2,maximumFractionDigits:2});
const fmtUSD=n=>USD.format(n);
const fmtPct=p=>isFinite(p)?(p*100).toFixed(2)+"%":"—";
const readMoney=el=>{ const digits=(el.value.match(/\d+/g)||[]).join(""); return digits===""?0:parseInt(digits,10)/100; };
function maskMoney(el){ const digits=(el.value.match(/\d+/g)||[]).join(""); const cents=digits===""?0:parseInt(digits,10); el.value=USD.format((isNaN(cents)?0:cents)/100); }
function readOdds(el){ const t=(el.value||"").trim(); if(!/^[+-]?\d+$/.test(t)) return NaN; return Number(t); }
const isValidOdds = n => Number.isFinite(n) && Math.abs(n) >= 100;
const americanToProb = (o)=> (!Number.isFinite(o)||o===0)?NaN : (o>0? 100/(o+100) : Math.abs(o)/(Math.abs(o)+100));
const stakeForWin = (o,w)=> (!Number.isFinite(o)||!Number.isFinite(w)||o===0)?NaN : (o>0? (w*100)/o : (w*Math.abs(o))/100);

/* --- UI refs --- */
const $=id=>document.getElementById(id);

/* --- Rendering --- */
function renderMain(){
  const winEl=$("win"), oddsEl=$("odds");
  const okWin = (maskMoney(winEl), readMoney(winEl) > 0);
  const o=readOdds(oddsEl), okOdds=isValidOdds(o);
  oddsEl.classList.toggle("valid", okOdds); oddsEl.classList.toggle("invalid", !okOdds && oddsEl.value.trim()!=="");

  if(!okWin || !okOdds){
    $("stakeOut").textContent="—";
    $("breakeven").textContent="—";
    $("rangeNote").textContent="Enter win amount and valid odds (±100 window will appear).";
    $("grid").innerHTML="";
    return;
  }

  const win=readMoney(winEl);
  $("stakeOut").textContent = fmtUSD(stakeForWin(o, win));
  $("breakeven").textContent = fmtPct(americanToProb(o));

  renderWindow(win, o);
}

function windowBounds(odds){
  // Build a 100-point band on the SAME SIGN as entered odds.
  if(odds<0){
    let start = odds - 100;
    let end   = odds + 100;
    // clamp to <= -100
    end = Math.min(end, -100);
    start = Math.min(start, odds); // ensure start <= odds
    // if start > end (e.g., odds near -100), widen backward
    if(start > end) start = end - 100;
    return [start, end];
  }else{
    let start = odds - 100;
    let end   = odds + 100;
    // clamp to >= +100
    start = Math.max(start, 100);
    end   = Math.max(end, odds); // ensure end >= odds
    if(start > end) end = start + 100;
    return [start, end];
  }
}

function autoSize(cell){
  const amt=cell.querySelector('.amt'); if(!amt) return;
  const len=amt.textContent.length;
  if(len>12){ amt.style.fontSize="9px"; }
  else if(len>10){ amt.style.fontSize="9.8px"; }
  else{ amt.style.fontSize="10.5px"; }
}

function renderWindow(winAmt, odds){
  const [start, end] = windowBounds(odds);
  $("rangeNote").textContent = `Showing stakes for odds ${start} … ${end} (step 1)`;
  const grid=$("grid");
  grid.innerHTML="";
  for(let o=start; o<=end; o++){
    if(o===0 || (Math.abs(o)<100)) continue; // guard, though bounds already preserve sign-validity
    const stake = stakeForWin(o, winAmt);
    const div=document.createElement('div'); div.className='cell';
    const left=document.createElement('div'); left.className='odds'; left.textContent=String(o);
    const right=document.createElement('div'); right.className='amt'; right.textContent=fmtUSD(stake);
    div.appendChild(left); div.appendChild(right); grid.appendChild(div);
    autoSize(div);
  }
}

/* --- Init --- */
function init(){
  $("win").value="$0.00";
  $("odds").value="";
  $("rangeNote").textContent="Enter win amount and odds to view the ±100 window.";

  ["win","odds"].forEach(id=>$(id).addEventListener("input", renderMain));
  $("toggleOdds").addEventListener("click", ()=>{
    const el=$("odds"); if(!el.value) return;
    el.value = el.value.startsWith("-") ? el.value.slice(1)
             : (el.value.startsWith("+") ? "-"+el.value.slice(1)
             : "-"+el.value);
    renderMain();
  });

  // PWA SW safe no-op
  if('serviceWorker'in navigator){navigator.serviceWorker.register('service-worker.js').catch(()=>{});}

  renderMain();
}
if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", init); else init();
</script>
</body>
</html>
